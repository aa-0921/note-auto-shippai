// createAndPublishPaidArticle.js
// 有料記事を作成して自動投稿するスクリプト

import { runWithCore } from '@aa-0921/note-auto-core';

// アフィリエイト設定とリンクを別ファイルから読み込み
import { affiliateConfig, affiliateLinks } from './affiliateConfig.js';

// 記事内容配列（A）を読み込み
import articleContents from './articleContents.js';

// 再エクスポート（他のファイルから参照できるように）
export { affiliateConfig, affiliateLinks };

(async () => {
  await runWithCore(async ({ core, wantsBackground }) => {
    // このスクリプトだけ異なるAIモデルを使用する
    core.aiGenerator.models.article = 'tngtech/deepseek-r1t2-chimera:free';
    core.aiGenerator.models.rewrite = 'tngtech/deepseek-r1t2-chimera:free';
    core.aiGenerator.models.tags = 'tngtech/deepseek-r1t2-chimera:free';
    console.log('使用するAIモデル:', core.aiGenerator.models);

    // 失敗のテーマ・キーワード（ここを書き換えて調整してください）
    const topics = [
      'エリートサラリーマンがSNSの裏垢で犯した致命的なミス',
      '完璧なママ友が、たった一度の「見栄」で全てを失った話',
      'SNSの匿名相談箱に届く衝撃的な懺悔・失敗事例',
      '転落劇から学ぶ「人生を狂わせない」教訓',
      '順風満帆だった彼がすべてを失うまで',
      '幸せの絶頂にいた彼女が踏み外した一つのボタンの掛け違い',
      '裏垢・匿名アカウントで起きた取り返しのつかない失敗',
      'ママ友・職場・SNSで全てを失った話',
    ];

    // 記事のパターンを増やすための配列（構成・見出しのバリエーション）
    const patterns = [
      '読者の悩みや「怖いもの見たさ」から入る構成',
      'この先に待ち受ける結末の凄まじさを最初に示す構成',
      '相談件数・DM数など具体的な数字で説得力を出す構成',
      '予兆→転落→結末の時系列で追う構成',
      '失敗談から学ぶ実体験ベースの構成',
      '男性の失敗と女性の失敗を対比して見せる構成',
      'Before/Afterで「あの時点では」と「今」の落差を示す構成',
      'チェックリスト形式で「やってはいけないこと」を示す構成',
      'Q&A形式で「なぜそうなったのか？」に答える構成',
      'ストーリーテリングで共感と生々しさを生む構成',
      '比較・対比で「あの選択とこの選択」の分岐を明確にする構成',
      'よくある油断を指摘して破滅のパターンを示す構成',
      '時系列で転落過程を追う構成',
      '読者の感情に訴えかけるストーリー構成',
      '導入・無料部分・有料部分の流れで整理して伝える構成',
      // 思わずクリックしたくなる見出しパターン（懺悔・失敗系）
      '【順風満帆だった彼が】すべてを失うまで',
      '【幸せの絶頂にいた彼女が】踏み外したたった一つのボタン',
      '【エリートサラリーマンが】SNSの裏垢で犯した致命的なミス',
      '【完璧なママ友が】たった一度の見栄で全てを失った話',
      '【匿名相談に届いた】衝撃の懺悔2本',
      '【年間3000件超】その中から選んだ男性の失敗と女性の失敗',
      '【無慈悲な結末】の前にあった「予兆」と「直前」',
      '【なぜそうなったのか】有料で明かす破滅の決定打',
      '【人生を狂わせないために】今すぐ刻んでおくべきこと',
      '【SNSの裏側で見てきた】人間の本質',
      '【転落劇から学ぶ】二度と踏み外さない教訓',
      '【隠されていた真実】が明かされる結末',
      '【怖いもの見たさ】で読む、生々しい失敗事例',
      '【無料でここまで】有料で結末と教訓を',
      '【男性の失敗】と【女性の失敗】を1本ずつ',
      '【相談箱に届く】懺悔のなかから選んだ2本',
      // 〇〇な理由・〇〇の正体系
      '【あの人が転落した】本当の理由',
      '【順調だった人が崩れた】意外なきっかけ',
      '【見栄が仇になった】よくあるパターン',
      '【裏垢がバレた】先に待っていた末路',
      '【たった一度の】判断ミスで全てを失った話',
      '【〇〇が引き金】で全てを失った男性の話',
      '【〇〇が引き金】で全てを失った女性の話',
      '【〇〇が秘訣】人生を狂わせないために避けること',
      '【〇〇が落とし穴】順風満帆だった人が陥るパターン',
    ];

    const rewriteConditionsLines = [
      'あなたは、SNSの匿名相談箱に届く懺悔・失敗を読み解くインフルエンサーです。',
      '指定の見出し本文が短いため、200文字以上になるよう心理描写や具体例を交えて厚くリライトしてください。',
      'トーン：冷静だが、どこか冷徹で生々しい。読者の「怖いもの見たさ」を刺激する。',
      '【注意】',
      '- タイトルや見出しは出力せず、本文のみを返す。',
      '- メタ情報（追加要素や文字数など）は一切出力しない。',
      '- 丁寧な敬語（です・ます）で、読みやすさ重視。',
      '- 絵文字を多めに、各行に1つ程度。',
      '- 元の内容に沿い、noteのMarkdownのみ使用。',
      '- 箇条書きは「・ 」、番号付きリストは使わない。',
      '- 特殊トークンや制御文字（<|begin_of_sentence|>等）は絶対に出力しない。',
      '- 自然で読みやすい日本語のみを出力する。',
      '- 完成した文章のみを返し、システムメッセージや処理情報は含めない。',
      '- 日本語の文章の中に英単語を混ぜないでください。すべて日本語で表現してください。',
      '- 【重要】絵文字を使用する場合は句読点（。や、）は付けないでください。句読点と絵文字を同時に使うことは禁止です。絵文字を使う場合は句読点は不要です。',
    ];

    // LLM用システムプロンプト（匿名相談箱・懺悔・失敗事例の有料記事用）
    const systemMessage =
      'あなたは、SNSの匿名相談箱に届く年間3,000件超の「懺悔・失敗」を読み解くインフルエンサーです。フォロワー数万人のアカウントを運営しており、日々届く生々しい転落劇の中から、特に衝撃的な「男性の失敗」と「女性の失敗」を1つずつ選び、noteの有料記事を執筆してください。' +
      '【最重要】記事は必ず「## 有料セクション」の見出しを含め、その後に5000文字程度の詳細な内容を最後まで完全に生成してください。途中で生成を止めてはいけません。';

    // 記事生成プロンプト条件（有料記事の構成はもともとの4部構成。内容のテイストは失敗談）
    const articleConditionsLines = [
      '【最重要】記事は必ず以下の4つの見出しを含めて、最後まで完全に生成してください：',
      '1. ## はじめに',
      '2. ## 有料記事部分のご紹介',
      '3. ## 有料部分の内容について',
      '4. ## 有料セクション',
      '',
      '【最重要】「## 有料セクション」の見出しの後に、必ず5000文字程度の詳細な内容を書いてください。',
      '記事が途中で終わってはいけません。「## 有料セクション」の内容を最後まで完全に生成してください。',
      '',
      '【失敗談としてのテイスト】今回の記事は「懺悔・失敗」を扱う失敗談です。指定された切り口（topics）・パターン（patterns）に沿い、男性の失敗と女性の失敗を扱う内容にしてください。トーンは冷静で冷徹・生々しく、心理描写と「怖いもの見たさ」を意識し、SNSのDM数・相談件数などの具体的数値を適宜盛り込んでください。',
      '',
      'タイトル、本文、ハッシュタグ（#から始まるもの）を含めてください。',
      'タイトルは1行目に「# [実際のタイトル] | 大失敗 | 失敗談 | 懺悔 | 匿名相談 | 転落 | 破滅の決定打 | 教訓 」として記載してください。',
      '「# タイトル」という文字列ではなく、実際の記事タイトルを入れてください。',
      'タイトルや本文には、できるだけ「懺悔」「失敗」「匿名相談」「SNS」「転落」などのキーワードを自然な形で盛り込んでください。',
      '本文にはタイトルを含めないでください。',
      '',
      '【記事の構造】以下の順序で必ず作成してください：',
      '',
      '## はじめに',
      '導入部分（無料で読める部分、500文字程度）',
      '   ・ 読者の興味を引く導入（失敗談・懺悔の記事として）',
      '   ・ 記事の概要や背景（匿名相談箱で見てきたこと等）',
      '   ・ 読者が共感できる悩みや「怖いもの見たさ」',
      '',
      '## 有料記事部分のご紹介',
      '有料記事部分のメリット案内（200文字程度）',
      '   ・ 有料セクションで読める記事内容の価値やメリットのみを記載',
      '   ・ 記事の内容以外のサービス（スクリーンショット、ショートカット一覧、サポート体制など）は絶対に記載しない',
      '   ・ 記事コンテンツで得られる知識やノウハウのみを説明する',
      '',
      '## 有料部分の内容について',
      '有料部分でどんな記事内容が読めるのかを読者に伝えるセクションです。',
      '   ・ 箇条書き（「・ 」）で3〜7個程度、記事内のトピックを並べてください。',
      '   ・ 各項目は1〜2文で簡潔に、でも具体的に記述してください。',
      '   ・ 「誰向けか」「どんな変化・成果が期待できるか」も含めてください。',
      '   ・ ここはあくまで有料部分の"目次・要約"であり、本文そのものではありません。',
      '   ・ 【重要】記事の内容のみを記載し、記事以外のサービス（スクリーンショット、ショートカット一覧、サポート体制、質問し放題など）は絶対に記載しないでください。',
      '',
      '## 有料セクション',
      '【重要】このセクションは5000文字程度の詳細な内容を必ず書いてください。',
      '   ・ 失敗談・懺悔の事例の結末、破滅の決定打、隠されていた真実、教訓など、具体的で実践的な内容',
      '   ・ 読者が求める深い情報やノウハウ',
      '   ・ 見出し（### サブ見出し）や箇条書きを交えて丁寧にまとめてください',
      '   ・ 実体験や具体例を豊富に含めてください',
      '   ・ 人生を狂わせないために刻んでおくべきことなど、読者が得られる学びを提供してください',
      '   ・ このセクションを最後まで完全に生成してください。途中で終わってはいけません。',
      '',
      '【最終確認】記事には必ず以下の4つの見出しが順番通りに含まれていることを確認してください：',
      '1. ## はじめに',
      '2. ## 有料記事部分のご紹介',
      '3. ## 有料部分の内容について',
      '4. ## 有料セクション（この後に5000文字程度の詳細な内容を必ず書く）',
      '',
      'ハッシュタグは記事末尾に「#〇〇 #〇〇 ...」の形式でまとめてください。',
      '読みやすさを重視してください。',
      '可能であればランキング形式やステップ形式を取り入れてください。',
      '改行を多めに入れてください。',
      '各行に1つ程度、絵文字を使用してください。',
      'すべて日本語で出力してください。',
      '切り口に沿った内容にしてください。',
      // '女性読者に寄り添う温かみのある文章を心がけてください。',
      '実体験や成功事例を交えて、読者が「自分にもできそう」と思える内容にしてください。',
      'noteの正しいマークダウン記法のみを使ってください。',
      '箇条書きはマークダウンではなく、「・ 」で表現してください。',
      '見出しはh2（## 見出し）・h3（### 見出し）のみ。',
      '見出しに「**」等は使わないでください。',
      '番号付きリストは使わないでください。',
      'h1（# タイトル）はタイトル行のみで本文中では使わないでください。',
      'noteの正しいマークダウン記法のみを使用し、箇条書きは「・ 」で表現してください。',
      '見出しはh2（## 見出し）・h3（### 見出し）のみ。見出しに「**」は使わないでください。',
      '番号付きリストは使わないでください。h1（# タイトル）はタイトル行のみで本文中では使わないでください。',
      'その他のマークダウンやHTMLタグは使わないでください。',
      '【重要】特殊トークンや制御文字（<|begin_of_sentence|>、<|end_of_sentence|>等）は絶対に出力しないでください。',
      '【重要】自然で読みやすい日本語のみを出力し、システムメッセージや処理情報は一切含めないでください。',
      '【重要】完成した記事のみを返してください。',
      '【重要】日本語の文章の中に英単語を混ぜないでください。すべて日本語で表現してください。',
      '【重要】絵文字を使用する場合は句読点（。や、）は付けないでください。句読点と絵文字を同時に使うことは禁止です。絵文字を使う場合は句読点は不要です。例：「誰でも始められる不労所得の選択肢が広がります🌐」のように、絵文字の前後に句読点を付けないでください。',
      '',
      '【禁止事項】記事の提供以外のサービスを保証するような内容は絶対に記載しないでください。',
      '   ・ スクリーンショットの提供',
      '   ・ ショートカット一覧の提供',
      '   ・ サポート体制や質問し放題のサービス',
      '   ・ 記事以外の特典や追加サービス',
      '   ・ 上記のような内容を暗示する表現も使用しないでください。',
      '',
      '【最終確認】記事には必ず「## 有料部分の内容について」と「## 有料セクション」という見出しが含まれていることを確認してください。',
      'これらの見出しが含まれていない記事は無効です。',
    ];

    // タグ生成の指示文（懺悔・失敗事例記事用）
    const tagsInstruction =
      '記事内容から最も関連する日本語タグを3〜5個生成し、半角スペース区切りで出力してください。必ず「#懺悔 #失敗 #匿名相談 #SNS #転落」を含めてください。本文や説明は禁止。';

    // タイトル装飾用絵文字（参考実装のセット）
    const titleEmojis = [
      '❤️',
      '🌸',
      '🛑',
      '㊙︎',
      '🟥',
      '🈲',
      '🉐',
      '㊗️',
      '㊙️',
      '⭕',
      '‼️',
      '🎉',
    ];

    // ----------------------------------------------------------------------------------

    // 有料記事設定（AI稼ぎ方.mdの価格帯に寄せる）
    const paidEnabled = true; // 有料記事にするか
    // 価格をランダムに選択（AI稼ぎ方.mdを参考にした価格帯）
    const priceOptions = [198, 298];
    // const priceOptions = [3980];
    const price = priceOptions[Math.floor(Math.random() * priceOptions.length)];
    console.log(`選択された価格: ${price}円`);

    // 記事内容配列（A）が存在するかチェック
    const articleContentsArray = Array.isArray(articleContents) && articleContents.length > 0
      ? articleContents
      : undefined;

    // 記事の自動生成と有料記事としての投稿機能を実行
    await core.runCreateAndPublishPaidArticle({
      background: wantsBackground,
      // 記事内容配列（A）が存在する場合はそれを渡す（存在しない場合は topics と patterns を使用）
      articleContents: articleContentsArray,
      topics,
      patterns,
      paidEnabled,
      price,
      systemMessage,
      articleConditionsLines,
      rewriteConditionsLines,
      tagsInstruction,
      titleEmojis,
      // 有料記事ではアフィリエイトリンク、おすすめ記事セクションは不要（core側で無効化）
      affiliateLinks: [],
      magazinePromotion: [],
      amazonAssociateText: '',
      // おすすめ記事セクション設定（有料記事では不要）
      recommendedArticlesTitle: '',
      recommendedArticlesUrls: [],
      // 有料記事用の設定
      maxTokens: 12000, // 長い記事を生成するため
      paidMode: true, // 有料記事モードを有効化
      paidRewriteHeading: '有料部分の内容について', // このセクションのみリライト
    });
    console.log('有料記事の自動生成と投稿が完了しました');
  });
})();
